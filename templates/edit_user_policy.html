{% extends "base.html" %}

{% block title %}Edit Policy Application - Insurance System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-edit"></i> Edit Policy Application</h2>
        <a href="{{ url_for('user_policies') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Policy Applications
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form action="{{ url_for('edit_user_policy', policy_id=policy.id) }}" method="POST">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="user_id" class="form-label">User *</label>
                        <select class="form-select" id="user_id" name="user_id" required>
                            {% for user_id, user in users.items() %}
                            <option value="{{ user_id }}" {% if policy.user_id == user_id %}selected{% endif %}>
                                {{ user.first_name }} {{ user.last_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="policy_template_id" class="form-label">Policy Template *</label>
                        <select class="form-select" id="policy_template_id" name="policy_template_id" required>
                            {% for template_id, template in templates.items() %}
                            <option value="{{ template_id }}" {% if policy.policy_template_id == template_id %}selected{% endif %}>
                                {{ template.name }} ({{ template.term }} years)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="premium_amount" class="form-label">Premium Amount (â‚¹) *</label>
                        <input type="number" class="form-control" id="premium_amount" name="premium_amount" 
                               step="0.01" min="0" value="{{ policy.premium_amount }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label">Status *</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="New" {% if policy.status == 'New' %}selected{% endif %}>New</option>
                            <option value="Talking" {% if policy.status == 'Talking' %}selected{% endif %}>Talking</option>
                            <option value="Payment Due" {% if policy.status == 'Payment Due' %}selected{% endif %}>Payment Due</option>
                            <option value="User Accepted" {% if policy.status == 'User Accepted' %}selected{% endif %}>User Accepted</option>
                            <option value="Submitted to LIC Branch Office" {% if policy.status == 'Submitted to LIC Branch Office' %}selected{% endif %}>Submitted to LIC Branch Office</option>
                            <option value="Gave Payment Receipt to the User" {% if policy.status == 'Gave Payment Receipt to the User' %}selected{% endif %}>Gave Payment Receipt to the User</option>
                            <option value="Yet to Receive Money from the User" {% if policy.status == 'Yet to Receive Money from the User' %}selected{% endif %}>Yet to Receive Money from the User</option>
                            <option value="Renewal Pending" {% if policy.status == 'Renewal Pending' %}selected{% endif %}>Renewal Pending</option>
                            <option value="Renewal Payment Received" {% if policy.status == 'Renewal Payment Received' %}selected{% endif %}>Renewal Payment Received</option>
                            <option value="Renewal of Amount Paid" {% if policy.status == 'Renewal of Amount Paid' %}selected{% endif %}>Renewal of Amount Paid</option>
                            <option value="Matured Amount Yet to Disbursed" {% if policy.status == 'Matured Amount Yet to Disbursed' %}selected{% endif %}>Matured Amount Yet to Disbursed</option>
                            <option value="Matured Amount Disbursed" {% if policy.status == 'Matured Amount Disbursed' %}selected{% endif %}>Matured Amount Disbursed</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="application_start_date" class="form-label">Application Start Date *</label>
                        <input type="date" class="form-control" id="application_start_date" 
                               name="application_start_date" value="{{ policy.application_start_date }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="application_issued_date" class="form-label">Application Issued Date</label>
                        <input type="date" class="form-control" id="application_issued_date" 
                               name="application_issued_date" value="{{ policy.application_issued_date or '' }}">
                        <div class="form-text">Leave blank if not issued yet</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="maturity_date" class="form-label">Maturity Date</label>
                        <input type="date" class="form-control" id="maturity_date" 
                               name="maturity_date" value="{{ policy.maturity_date or '' }}" readonly>
                        <div class="form-text">Auto-calculated based on start date and policy term</div>
                        <div id="maturity-info">
                            {% if policy.maturity_date %}
                                <small class="text-info"><i class="fas fa-info-circle"></i> Current Maturity Date: <strong>{{ policy.maturity_date }}</strong></small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3">{{ policy.notes or '' }}</textarea>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Application
                    </button>
                    <a href="{{ url_for('user_policies') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-populate maturity date when policy template or start date changes
function calculateMaturityDate() {
    const templateId = document.getElementById('policy_template_id').value;
    const startDate = document.getElementById('application_start_date').value;
    
    if (templateId && startDate) {
        fetch('/calculate-maturity-date', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                template_id: templateId,
                start_date: startDate
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.maturity_date) {
                document.getElementById('maturity_date').value = data.maturity_date;
                const maturityInfo = document.getElementById('maturity-info');
                maturityInfo.innerHTML = `<small class="text-info"><i class="fas fa-info-circle"></i> Updated Maturity Date: <strong>${data.maturity_date}</strong></small>`;
            }
        })
        .catch(error => {
            console.error('Error calculating maturity date:', error);
        });
    }
}

// Add event listeners when document is loaded
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('policy_template_id');
    const startDateInput = document.getElementById('application_start_date');
    
    if (templateSelect && startDateInput) {
        templateSelect.addEventListener('change', calculateMaturityDate);
        startDateInput.addEventListener('change', calculateMaturityDate);
    }
});
</script>
{% endblock %}

